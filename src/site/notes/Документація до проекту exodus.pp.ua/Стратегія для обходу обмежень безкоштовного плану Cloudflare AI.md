---
{"title":"Стратегія для обходу обмежень безкоштовного плану Cloudflare AI","dg-publish":true,"dg-metatags":null,"dg-home":null,"permalink":"/dokumentacziya-do-proektu-exodus-pp-ua/strategiya-dlya-obhodu-obmezhen-bezkoshtovnogo-planu-cloudflare-ai/","dgPassFrontmatter":true,"noteIcon":""}
---


### Оцінка перспективи стратегії

#### **1. Каскадні запити з автоматичним продовженням**
Цей підхід дозволяє обробляти великі тексти або генерувати довгі відповіді, розбиваючи їх на менші частини в межах одного акаунта Cloudflare.

- **Переваги**:
  - Ефективно долає обмеження довжини відповідей шляхом послідовної обробки.
  - Використання Cloudflare Worker для автоматичного виявлення обрізаних відповідей (маркування їх як [TRUNCATED]) спрощує процес.
  - n8n забезпечує управління робочим процесом, повторюючи запити до завершення завдання.

- **Недоліки**:
  - Можливе збільшення затримки через послідовність запитів.
  - Складність реалізації та налагодження, якщо маркування обрізаних відповідей працює не ідеально.
  - Потенційні обмеження на частоту запитів у межах одного акаунта.

Цей метод уже довів свою ефективність для одного акаунта, що робить його міцною основою для масштабування.

#### **2. Оркестрація кількох акаунтів через LiteLLM**
Використання LiteLLM для розподілу навантаження між кількома акаунтами Cloudflare може пропорційно збільшити пропускну здатність вашої системи.

- **Переваги**:
  - Кожен акаунт має власну квоту безкоштовного плану, тому їх об’єднання множить загальну доступну потужність.
  - LiteLLM як LLM-проксі спрощує балансування навантаження та перемикання між акаунтами.
  - Збільшує можливості обробки великих обсягів даних і генерації довгих відповідей.

- **Недоліки**:
  - Управління кількома акаунтами може ускладнити конфігурацію та моніторинг.
  - Важливо переконатися, що це не суперечить умовам обслуговування Cloudflare (рекомендується перевірити ToS).

Оскільки ви використовуєте безкоштовний план, витрати не є проблемою, але ключовим є дотримання правил Cloudflare щодо використання кількох акаунтів. Якщо це дозволено, стратегія значно підвищить продуктивність вашої RAG-системи.

### Детальний план впровадження оркестрації кількох акаунтів за допомогою LiteLLM

Нижче наведено покроковий план для інтеграції LiteLLM у вашу систему з урахуванням каскадних запитів і n8n.

#### **Крок 1: Підготовка кількох акаунтів Cloudflare**
- Створіть кілька акаунтів Cloudflare, кожен із підключеним безкоштовним планом AI.
- Переконайтеся, що кожен акаунт має доступ до API Cloudflare AI та унікальний API-ключ.

#### **Крок 2: Налаштування LiteLLM як проксі та балансувальника**
- Встановіть LiteLLM на вашому сервері або хмарному середовищі (дотримуйтесь інструкцій із [документації LiteLLM](https://docs.litellm.ai)).
- Налаштуйте список акаунтів Cloudflare у конфігурації LiteLLM, вказавши API-ключи та кінцеві точки для кожного акаунта.
  ```yaml
  model_list:
    - model_name: cloudflare-ai
      litellm_params:
        api_key: "<API_KEY_1>"
        api_base: "https://api.cloudflare.com/client/v4/accounts/<ACCOUNT_1>/ai"
    - model_name: cloudflare-ai
      litellm_params:
        api_key: "<API_KEY_2>"
        api_base: "https://api.cloudflare.com/client/v4/accounts/<ACCOUNT_2>/ai"
  ```
- Виберіть стратегію балансування навантаження (наприклад, round-robin або least busy) для рівномірного розподілу запитів.

#### **Крок 3: Інтеграція LiteLLM із n8n**
- Змініть робочий процес у n8n, щоб запити надсилалися через проксі LiteLLM замість прямого звернення до одного акаунта Cloudflare.
  - Оновіть вузол HTTP Request у n8n, вказавши URL проксі LiteLLM (наприклад, `http://<your-litellm-server>:8000`).
  - Передайте параметри запиту у форматі, сумісному з LiteLLM (див. документацію).
- Переконайтеся, що n8n розпізнає маркер [TRUNCATED] у відповідях і запускає повторні запити через LiteLLM.

#### **Крок 4: Розгортання Cloudflare Worker на всіх акаунтах**
- Розгорніть однаковий Cloudflare Worker на кожному акаунті для обробки відповідей від AI.
- Worker має перевіряти, чи була відповідь обрізана (наприклад, через досягнення ліміту), і додавати маркер [TRUNCATED], якщо це необхідно.
  ```javascript
  addEventListener('fetch', event => {
    event.respondWith(handleRequest(event.request));
  });

  async function handleRequest(request) {
    const response = await fetch(request);
    const text = await response.text();
    if (text.length >= MAX_LENGTH) { //MAX_LENGTH залежить від обмежень Cloudflare
      return new Response(text + " [TRUNCATED]", { status: 200 });
    }
    return new Response(text, { status: 200 });
  }
  ```
- Перевірте, чи Worker коректно працює на всіх акаунтах.

#### **Крок 5: Тестування системи**
- Запустіть тестові завдання з великими текстами або запитами на довгі відповіді.
- Переконайтеся, що:
  - LiteLLM розподіляє запити між акаунтами.
  - Cloudflare Worker маркує обрізані відповіді.
  - n8n успішно обробляє каскадні запити до завершення завдання.

#### **Крок 6: Моніторинг та оптимізація**
- Відстежуйте продуктивність системи (затримки, використання квот кожного акаунта) через логи LiteLLM і Cloudflare.
- Оптимізуйте стратегію балансування в LiteLLM, якщо один із акаунтів перевантажується або досягає лімітів швидше за інших.

#### **Крок 7: Обробка помилок і резервні механізми**
- Додайте в n8n логіку для обробки помилок (наприклад, якщо акаунт досягає ліміту запитів).
- Налаштуйте LiteLLM для автоматичного перемикання на інший акаунт у разі збою.
- Встановіть сповіщення (наприклад, через n8n) для моніторингу стану акаунтів.
