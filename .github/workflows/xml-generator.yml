name: Generate Repository XML and Upload to MinIO via Cloudflare

on:
  push:
    branches: [main]
    paths:
      - "src/site/notes/**"
      - "*.*"
  pull_request:
    branches: [main]
    paths:
      - "src/site/notes/**"
      - "*.*"

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest

    env:
      MINIO_ENDPOINT_URL: https://apiminio.exodus.pp.ua
      AWS_ACCESS_KEY_ID: ${{ secrets.MINIO_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.MINIO_SECRET_KEY }}
      AWS_DEFAULT_REGION: us-east-1
      AWS_S3_DISABLE_MULTIPART: "1"

    steps:
      # ÐšÑ€Ð¾Ðº 1: ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ð½Ð½Ñ ÐºÐ¾Ð´Ñƒ Ð· Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ñ–ÑŽ
      - name: Checkout repository
        uses: actions/checkout@v4

      # ÐšÑ€Ð¾Ðº 2: Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ð¸Ñ… Ð·Ð°Ð»ÐµÐ¶Ð½Ð¾ÑÑ‚ÐµÐ¹ Ñ‚Ð° AWS CLI v2
      - name: Install system dependencies and AWS CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip curl
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -q awscliv2.zip
          sudo ./aws/install --update
          aws --version

      # ÐšÑ€Ð¾Ðº 3: ÐÐ°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ AWS CLI Ð´Ð»Ñ Ñ€Ð¾Ð±Ð¾Ñ‚Ð¸ Ð· MinIO
      - name: Configure AWS CLI for MinIO via Cloudflare
        run: |
          aws configure set default.region us-east-1
          aws configure set default.s3.addressing_style path
          aws configure set default.s3.signature_version s3v4
          aws configure set default.s3.max_concurrent_requests 1
          aws configure set default.s3.max_bandwidth 50MB/s

      # ÐšÑ€Ð¾Ðº 4: ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ñƒ Ð´Ð¾ MinIO
      - name: Verify AWS CLI credentials with MinIO
        run: |
          echo "ðŸ” ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ñƒ Ð´Ð¾ MinIO..."
          if ! aws --endpoint-url "$MINIO_ENDPOINT_URL" s3 ls; then
            echo "âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ñ–Ñ— Ð°Ð±Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¸Ð¹ MinIO endpoint"
            exit 1
          fi
          echo "âœ… Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ð´Ð¾ MinIO Ð¿Ñ–Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¶ÐµÐ½Ð¾"

      # ÐšÑ€Ð¾Ðº 5: Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ñ‚Ñ€Ð°Ð½ÑÐ»Ñ–Ñ‚ÐµÑ€Ð°Ñ†Ñ–Ñ— ÐºÐ¸Ñ€Ð¸Ð»Ð¸Ñ†Ñ–
      - name: Generate transliteration script
        run: |
          cat > transliterate.sh << 'EOF'
          #!/bin/bash
          transliterate() {
              local input="$1"
              input=$(echo "$input" | sed 's/Ð°/a/g; s/Ð±/b/g; s/Ð²/v/g; s/Ð³/h/g; s/Ò‘/g/g; s/Ð´/d/g; s/Ðµ/e/g; s/Ñ”/ye/g; s/Ð¶/zh/g; s/Ð·/z/g; s/Ð¸/y/g; s/Ñ–/i/g; s/Ñ—/yi/g; s/Ð¹/y/g; s/Ðº/k/g; s/Ð»/l/g; s/Ð¼/m/g; s/Ð½/n/g; s/Ð¾/o/g; s/Ð¿/p/g; s/Ñ€/r/g; s/Ñ/s/g; s/Ñ‚/t/g; s/Ñƒ/u/g; s/Ñ„/f/g; s/Ñ…/kh/g; s/Ñ†/ts/g; s/Ñ‡/ch/g; s/Ñˆ/sh/g; s/Ñ‰/shch/g; s/ÑŒ//g; s/ÑŽ/yu/g; s/Ñ/ya/g')
              input=$(echo "$input" | sed 's/Ð/A/g; s/Ð‘/B/g; s/Ð’/V/g; s/Ð“/H/g; s/Ò/G/g; s/Ð”/D/g; s/Ð•/E/g; s/Ð„/Ye/g; s/Ð–/Zh/g; s/Ð—/Z/g; s/Ð˜/Y/g; s/Ð†/I/g; s/Ð‡/Yi/g; s/Ð™/Y/g; s/Ðš/K/g; s/Ð›/L/g; s/Ðœ/M/g; s/Ð/N/g; s/Ðž/O/g; s/ÐŸ/P/g; s/Ð /R/g; s/Ð¡/S/g; s/Ð¢/T/g; s/Ð£/U/g; s/Ð¤/F/g; s/Ð¥/Kh/g; s/Ð¦/Ts/g; s/Ð§/Ch/g; s/Ð¨/Sh/g; s/Ð©/Shch/g; s/Ð¬//g; s/Ð®/Yu/g; s/Ð¯/Ya/g')
              input=$(echo "$input" | sed 's/[[:space:]]\+/-/g' | tr '[:upper:]' '[:lower:]')
              input=$(echo "$input" | sed 's/[^a-z0-9-]//g' | sed 's/--*/-/g; s/^-//; s/-$//')
              if [ ${#input} -lt 3 ]; then 
                  input="${input}bucket"
              fi
              if [ ${#input} -gt 63 ]; then 
                  input="${input:0:63}"
              fi
              echo "$input"
          }
          transliterate "$1"
          EOF
          chmod +x transliterate.sh

      # ÐšÑ€Ð¾Ðº 6: Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ñ–Ñ XML-Ñ„Ð°Ð¹Ð»Ñ–Ð² Ð´Ð»Ñ ÐºÐ¾Ð¶Ð½Ð¾Ñ— Ð¿Ð°Ð¿ÐºÐ¸ Ð² src/site/notes/
      - name: Generate XML files for each folder
        run: |
          mkdir -p xml-outputs
          if [ ! -d "src/site/notes/" ]; then
            echo "âŒ src/site/notes/ Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾"
            exit 1
          fi

          for folder in src/site/notes/*/; do
            if [ -d "$folder" ]; then
              folder_name=$(basename "$folder")
              bucket_name=$(./transliterate.sh "$folder_name")

              if [[ ! "$bucket_name" =~ ^[a-z0-9][a-z0-9-]{1,61}[a-z0-9]$ ]] && [[ ${#bucket_name} -ne 3 ]]; then
                echo "âŒ ÐÐµÐºÐ¾Ñ€ÐµÐºÑ‚Ð½Ð° Ð½Ð°Ð·Ð²Ð° Ð±Ð°ÐºÐµÑ‚Ñƒ: $bucket_name"
                exit 1
              fi

              echo "ðŸ”„ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ñ–Ñ XML: $folder_name -> $bucket_name"
              npx repomix --config repomix.config.json --include "$folder/**" --output "xml-outputs/${bucket_name}.xml"
              
              if [ ! -s "xml-outputs/${bucket_name}.xml" ]; then
                echo "âŒ XML-Ñ„Ð°Ð¹Ð» Ð¿Ð¾Ñ€Ð¾Ð¶Ð½Ñ–Ð¹ Ð°Ð±Ð¾ Ð½Ðµ ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð¸Ð¹: ${bucket_name}.xml"
                exit 1
              fi

              echo "âœ… Ð—Ð³ÐµÐ½ÐµÑ€Ð¾Ð²Ð°Ð½Ð¾: ${bucket_name}.xml"
            fi
          done

      # ÐšÑ€Ð¾Ðº 7: Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ñ–Ñ common.xml Ð´Ð»Ñ ÐºÐ¾Ñ€ÐµÐ½ÐµÐ²Ð¸Ñ… Ñ„Ð°Ð¹Ð»Ñ–Ð²
      - name: Generate common.xml for root files
        run: |
          echo "ðŸ”„ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ñ–Ñ common.xml Ð´Ð»Ñ ÐºÐ¾Ñ€ÐµÐ½ÐµÐ²Ð¸Ñ… Ñ„Ð°Ð¹Ð»Ñ–Ð²"
          npx repomix --config repomix.config.json --ignore "src/site/notes/**" --output "xml-outputs/common.xml"
          
          if [ ! -s "xml-outputs/common.xml" ]; then
            echo "âŒ common.xml Ð¿Ð¾Ñ€Ð¾Ð¶Ð½Ñ–Ð¹ Ð°Ð±Ð¾ Ð½Ðµ ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð¸Ð¹"
            exit 1
          fi

          echo "âœ… Ð—Ð³ÐµÐ½ÐµÑ€Ð¾Ð²Ð°Ð½Ð¾: common.xml"

      # ÐšÑ€Ð¾Ðº 8: Ð—Ð±ÐµÑ€ÐµÐ¶ÐµÐ½Ð½Ñ XML-Ñ„Ð°Ð¹Ð»Ñ–Ð² ÑÐº Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ–Ð²
      - name: Upload XML outputs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xml-outputs
          path: xml-outputs/
          retention-days: 7

      # ÐšÑ€Ð¾Ðº 9: Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ Ð´Ð¾Ð¿Ð¾Ð¼Ñ–Ð¶Ð½Ð¸Ñ… ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ–Ð² Ð´Ð»Ñ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ
      - name: Create upload helper scripts
        run: |
          cat > create_bucket.sh << 'EOF'
          #!/bin/bash
          bucket_name="$1"
          if aws --endpoint-url "$MINIO_ENDPOINT_URL" s3api head-bucket --bucket "$bucket_name" 2>/dev/null; then
            echo "â„¹ï¸ Ð‘Ð°ÐºÐµÑ‚ '$bucket_name' Ð²Ð¶Ðµ Ñ–ÑÐ½ÑƒÑ”"
          else
            echo "ðŸ”¨ Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ Ð±Ð°ÐºÐµÑ‚Ñƒ '$bucket_name'"
            if ! aws --endpoint-url "$MINIO_ENDPOINT_URL" s3api create-bucket --bucket "$bucket_name" --region us-east-1; then
              echo "âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð¿Ñ€Ð¸ ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ– Ð±Ð°ÐºÐµÑ‚Ñƒ '$bucket_name'"
              exit 1
            fi
          fi
          EOF
          
          cat > upload_file.sh << 'EOF'
          #!/bin/bash
          bucket_name="$1"
          file_path="$2"
          max_retries=3
          retry_count=0

          if [ ! -f "$file_path" ]; then
            echo "âŒ Ð¤Ð°Ð¹Ð» Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾: $file_path"
            exit 1
          fi

          file_size=$(wc -c < "$file_path")
          echo "ðŸ“Š Ð Ð¾Ð·Ð¼Ñ–Ñ€ Ñ„Ð°Ð¹Ð»Ñƒ: $file_size Ð±Ð°Ð¹Ñ‚Ñ–Ð²"

          if [ "$file_size" -eq 0 ]; then
            echo "âŒ Ð¤Ð°Ð¹Ð» Ð¿Ð¾Ñ€Ð¾Ð¶Ð½Ñ–Ð¹: $file_path"
            exit 1
          fi

          while [ $retry_count -lt $max_retries ]; do
            echo "ðŸ”„ Ð¡Ð¿Ñ€Ð¾Ð±Ð° $((retry_count + 1)): Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ ${bucket_name}.xml"
            
            # Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑ”Ð¼Ð¾ Ð¢Ð†Ð›Ð¬ÐšÐ˜ s3api put-object Ñ‡ÐµÑ€ÐµÐ· Cloudflare + acl
            if aws --endpoint-url "$MINIO_ENDPOINT_URL" s3api put-object \
              --bucket "$bucket_name" \
              --key "${bucket_name}.xml" \
              --body "$file_path" \
              --content-type "application/xml" \
              --acl public-read \
              --metadata-directive REPLACE; then
              echo "âœ… Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð¾: ${bucket_name}.xml"
              exit 0
            fi

            retry_count=$((retry_count + 1))
            echo "âš ï¸ Ð¡Ð¿Ñ€Ð¾Ð±Ð° $retry_count Ð· $max_retries Ð½Ðµ Ð²Ð´Ð°Ð»Ð°ÑÑ Ð´Ð»Ñ ${bucket_name}.xml"
            
            if [ $retry_count -lt $max_retries ]; then
              echo "â³ ÐžÑ‡Ñ–ÐºÑƒÐ²Ð°Ð½Ð½Ñ 5 ÑÐµÐºÑƒÐ½Ð´ Ð¿ÐµÑ€ÐµÐ´ Ð½Ð°ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑŽ ÑÐ¿Ñ€Ð¾Ð±Ð¾ÑŽ..."
              sleep 5
            fi
          done

          echo "âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ– ${bucket_name}.xml Ð¿Ñ–ÑÐ»Ñ $max_retries ÑÐ¿Ñ€Ð¾Ð±"
          exit 1
          EOF

          chmod +x create_bucket.sh upload_file.sh

      # ÐšÑ€Ð¾Ðº 10: Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ XML-Ñ„Ð°Ð¹Ð»Ñ–Ð² Ñƒ MinIO
      - name: Upload XML files to MinIO
        run: |
          echo "ðŸš€ Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ XML Ñƒ MinIO..."

          export AWS_MAX_ATTEMPTS=3
          export AWS_RETRY_MODE=adaptive

          for xml_file in xml-outputs/*.xml; do
            if [ -f "$xml_file" ]; then
              bucket_name=$(basename "$xml_file" .xml)

              echo "ðŸ“¦ ÐžÐ±Ñ€Ð¾Ð±ÐºÐ° Ñ„Ð°Ð¹Ð»Ñƒ: $xml_file -> Ð±Ð°ÐºÐµÑ‚: $bucket_name"

              if [ ! -s "$xml_file" ]; then
                echo "âŒ Ð¤Ð°Ð¹Ð» Ð¿Ð¾Ñ€Ð¾Ð¶Ð½Ñ–Ð¹: $xml_file"
                continue
              fi

              if ! ./create_bucket.sh "$bucket_name"; then
                echo "âŒ ÐÐµ Ð²Ð´Ð°Ð»Ð¾ÑÑ ÑÑ‚Ð²Ð¾Ñ€Ð¸Ñ‚Ð¸ Ð±Ð°ÐºÐµÑ‚ $bucket_name"
                exit 1
              fi

              if ! ./upload_file.sh "$bucket_name" "$xml_file"; then
                echo "âŒ ÐÐµ Ð²Ð´Ð°Ð»Ð¾ÑÑ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶Ð¸Ñ‚Ð¸ Ñ„Ð°Ð¹Ð» $xml_file"
                exit 1
              fi

              echo "âœ… Ð£ÑÐ¿Ñ–ÑˆÐ½Ð¾ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð¾: $xml_file"
            fi
          done

          echo "ðŸŽ‰ Ð’ÑÑ– Ñ„Ð°Ð¹Ð»Ð¸ ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð¾ Ð´Ð¾ MinIO"

      # ÐšÑ€Ð¾Ðº 11: Ð’ÐµÑ€Ð¸Ñ„Ñ–ÐºÐ°Ñ†Ñ–Ñ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð¸Ñ… Ñ„Ð°Ð¹Ð»Ñ–Ð²
      - name: Verify uploaded files
        run: |
          echo "ðŸ” ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð¸Ñ… Ñ„Ð°Ð¹Ð»Ñ–Ð²..."

          for xml_file in xml-outputs/*.xml; do
            if [ -f "$xml_file" ]; then
              bucket_name=$(basename "$xml_file" .xml)

              echo "ðŸ”Ž ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ñ„Ð°Ð¹Ð»Ñƒ Ð² Ð±Ð°ÐºÐµÑ‚Ñ–: $bucket_name"

              if aws --endpoint-url "$MINIO_ENDPOINT_URL" s3api head-object \
                --bucket "$bucket_name" \
                --key "${bucket_name}.xml" > /dev/null 2>&1; then
                echo "âœ… Ð¤Ð°Ð¹Ð» ${bucket_name}.xml Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð² Ð±Ð°ÐºÐµÑ‚Ñ–"

                remote_size=$(aws --endpoint-url "$MINIO_ENDPOINT_URL" s3api head-object \
                  --bucket "$bucket_name" \
                  --key "${bucket_name}.xml" \
                  --query 'ContentLength' --output text)

                local_size=$(wc -c < "$xml_file")

                if [ "$remote_size" = "$local_size" ]; then
                  echo "âœ… Ð Ð¾Ð·Ð¼Ñ–Ñ€ Ñ„Ð°Ð¹Ð»Ñƒ ÑÐ¿Ñ–Ð²Ð¿Ð°Ð´Ð°Ñ”: $remote_size Ð±Ð°Ð¹Ñ‚Ñ–Ð²"
                else
                  echo "âš ï¸ Ð Ð¾Ð·Ð¼Ñ–Ñ€ Ñ„Ð°Ð¹Ð»Ñƒ Ð½Ðµ ÑÐ¿Ñ–Ð²Ð¿Ð°Ð´Ð°Ñ”: Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¸Ð¹=$local_size, Ð²Ñ–Ð´Ð´Ð°Ð»ÐµÐ½Ð¸Ð¹=$remote_size"
                fi
              else
                echo "âŒ Ð¤Ð°Ð¹Ð» ${bucket_name}.xml Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð² Ð±Ð°ÐºÐµÑ‚Ñ–"
              fi
            fi
          done
